# 架构设计

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     用户输入                                  │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    Swarm 工作流                               │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐                  │
│  │  Agent1 │ → │ Agent2 │ → │ Agent3 │                  │
│  │  (wand) │   │ (review)│   │ (final)│                  │
│  └─────────┘   └─────────┘   └─────────┘                  │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    Memory Profile                            │
│                                                             │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐                  │
│  │   L0    │ → │   L1    │ → │   L2    │                  │
│  │  (100条)│   │ (500条) │   │ (无限)  │                  │
│  └─────────┘   └─────────┘   └─────────┘                  │
│       ↓              ↓              ↓                       │
│  ┌─────────────────────────────────────────────┐            │
│  │           自动机制                          │            │
│  │  • 增量同步  • 夜间反思  • 遗忘归档       │            │
│  └─────────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

---

## Swarm 模块

### Agent 流水线

每个 Agent 是一个独立环节：

1. **输入**: 上游输出 + 上下文
2. **处理**: 专注于自己的任务
3. **输出**: 传递给下游

### 协作机制

- **上下文传递**: 通过变量/文件
- **向量记忆**: 检索历史经验
- **交接确认**: 每个阶段有明确边界

---

## Memory Profile 模块

### 三层存储

#### L0: 即时记忆

```javascript
{
  type: "L0",
  maxSize: 100,
  ttl: "当天",
  usage: "当前任务上下文"
}
```

- 最近 100 条事件
- 每次对话结束更新
- 用途: 保持当前状态

#### L1: 短期记忆

```javascript
{
  type: "L1", 
  maxSize: 500,
  ttl: "30天",
  usage: "本周工作记忆"
}
```

- 最近 500 条事件
- 每日自动同步
- 用途: 跨天任务衔接

#### L2: 长期记忆

```javascript
{
  type: "L2",
  maxSize: "无限",
  ttl: "永久",
  usage: "知识库"
}
```

- 永久存储
- 需要手动归档
- 用途: 可复用知识

---

## 自动化机制

### 1. 增量同步

每次任务完成后：
1. 读取新增事件
2. 更新同步状态
3. 只同步变化部分

### 2. 夜间反思 (23:45)

每日自动执行：
1. 读取当日日志
2. 提取可复用知识
3. 写入 lessons/decisions
4. 标记过时信息

### 3. 垃圾归档 (周日)

每周自动执行：
1. 计算记忆温度
2. 归档过期内容
3. 清理无效数据

---

## 数据流

### 任务执行流程

```
用户输入
    ↓
意图识别 (intent.py)
    ↓
Agent 流水线 (串行/并行)
    ↓
结果存储 (向量数据库)
    ↓
记忆同步 (增量)
    ↓
学习记录 (learning)
```

### 记忆读取流程

```
Agent 启动
    ↓
读取 NOW.md (短期状态)
    ↓
读取 INDEX.md (知识导航)
    ↓
检索 L1/L2 (历史经验)
    ↓
注入上下文
    ↓
执行任务
```

---

## 配置说明

### Agent 配置

```bash
# swarm/scripts/agent.sh

case "$AGENT" in
    wand)          # 初稿
        call_api "你是一个专业作家：$TASK"
        ;;
    review)       # 审核
        call_api "你是一个专业编辑：$TASK"  
        ;;
    final)        # 终审
        call_api "你是一个优化专家：$TASK"
        ;;
esac
```

### 记忆配置

```javascript
// memory-profile/scripts/memory_system.cjs

const LAYERS = {
    L0: { maxSize: 100, ttl: 24 * 60 * 60 * 1000 },
    L1: { maxSize: 500, ttl: 30 * 24 * 60 * 60 * 1000 },
    L2: { maxSize: Infinity, ttl: Infinity }
};
```

---

## 扩展点

### 添加新 Agent

1. 修改 `agent.sh`
2. 添加 case 分支
3. 定义 prompt

### 添加新工作流

1. 复制 `artgroup.sh`
2. 修改 Agent 组合
3. 添加到 README

### 添加新记忆类型

1. 修改 `crud_validator.cjs`
2. 添加分类逻辑
3. 更新路由规则

---

## 性能优化

### 已实现

- 增量同步 (减少重复)
- 固定容量裁剪 (防止膨胀)
- 懒加载 (按需读取)

### 建议

- 大型部署: 使用 Redis 缓存
- 多用户: 隔离数据目录
- 高并发: 异步队列

---

## 监控

查看系统状态：

```bash
# 记忆统计
./memory-profile/memory.sh stats

# Swarm 状态
python3 swarm/scripts/evolver.py status

# 查看日志
tail -f /tmp/swarm-*.log
```
